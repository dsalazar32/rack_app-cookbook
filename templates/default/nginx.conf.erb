<% ns = node['ns'] %>
user <%= node[ns]['nginx']['user'] %><% if node[ns]['nginx']['user'] != node[ns]['nginx']['group'] %> <%= node[ns]['nginx']['group'] %><% end %>;
worker_processes  <%= node[ns]['nginx']['worker_processes'] %>;
<% if node[ns]['nginx']['daemon_disable'] -%>
  daemon off;
<% end -%>
<% if node[ns]['nginx']['worker_rlimit_nofile'] -%>
  worker_rlimit_nofile <%= node[ns]['nginx']['worker_rlimit_nofile'] %>;
<% end -%>

error_log  /var/log/nginx/error.log;
pid        <%= node[ns]['nginx']['pid'] %>;

events {
worker_connections  <%= node[ns]['nginx']['worker_connections'] %>;
<% if node[ns]['nginx']['multi_accept'] -%>
  multi_accept on;
<% end -%>
<% if node[ns]['nginx']['event'] -%>
  use <%= node[ns]['nginx']['event'] %>;
<% end -%>
}

http {
<% if node.recipe?('nginx::naxsi_module') %>
  include <%= node[ns]['nginx']['dir'] %>/naxsi_core.rules;
<% end %>

include <%= node[ns]['nginx']['dir'] %>/mime.types;
default_type  application/octet-stream;

<% if node[ns]['nginx']['disable_access_log'] -%>
  access_log off;
<% else -%>
  access_log <%= node[ns]['nginx']['log_dir'] %>/access.log<% if node[ns]['nginx']['access_log_options'] %> <%= node[ns]['nginx']['access_log_options'] %><% end %>;
<% end %>
<% if node[ns]['nginx']['server_tokens'] -%>
  server_tokens <%= node[ns]['nginx']['server_tokens'] %>;
<% end -%>

sendfile <%= node[ns]['nginx']['sendfile'] %>;
tcp_nopush on;
tcp_node[ns]lay on;

<% if node[ns]['nginx']['keepalive'] == 'on' %>
  keepalive_timeout  <%= node[ns]['nginx']['keepalive_timeout'] %>;
<% end %>

gzip  <%= node[ns]['nginx']['gzip'] %>;
<% if node[ns]['nginx']['gzip'] == 'on' %>
  gzip_http_version <%= node[ns]['nginx']['gzip_http_version'] %>;
  gzip_comp_level <%= node[ns]['nginx']['gzip_comp_level'] %>;
  gzip_proxied <%= node[ns]['nginx']['gzip_proxied'] %>;
  gzip_vary <%= node[ns]['nginx']['gzip_vary'] %>;
  <% if node[ns]['nginx']['gzip_buffers'] -%>
    gzip_buffers <%= node[ns]['nginx']['gzip_buffers'] %>;
  <% end -%>
  gzip_types <%= node[ns]['nginx']['gzip_types'].join(' ') %>;
  gzip_min_length  <%= node[ns]['nginx']['gzip_min_length'] %>;
  gzip_disable     "<%= node[ns]['nginx']['gzip_disable'] %>";
<% end %>

server_names_hash_bucket_size <%= node[ns]['nginx']['server_names_hash_bucket_size'] %>;
types_hash_max_size <%= node[ns]['nginx']['types_hash_max_size'] %>;
types_hash_bucket_size <%= node[ns]['nginx']['types_hash_bucket_size'] %>;
<% if node[ns]['nginx']['proxy_read_timeout'] -%>
  proxy_read_timeout <%= node[ns]['nginx']['proxy_read_timeout'] %>;
<% end -%>
<% if node[ns]['nginx']['client_body_buffer_size'] -%>
  client_body_buffer_size <%= node[ns]['nginx']['client_body_buffer_size'] %>;
<% end -%>
<% if node[ns]['nginx']['client_max_body_size'] -%>
  client_max_body_size <%= node[ns]['nginx']['client_max_body_size'] %>;
<% end -%>

<% if node[ns]['nginx']['enable_rate_limiting'] -%>
  limit_req_zone $binary_remote_addr zone=<%= node[ns]['nginx']['rate_limiting_zone_name'] %>:<%= node[ns]['nginx']['rate_limiting_backoff'] %> rate=<%= node[ns]['nginx']['rate_limit'] %>;

<% end -%>
include <%= node[ns]['nginx']['dir'] %>/conf.d/*.conf;
include <%= node[ns]['nginx']['dir'] %>/sites-enabled/*;
}
